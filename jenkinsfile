pipeline {
  agent none
  environment {
    CI = 'true'
  }
  stages {
    stage('Checkout') {
      agent any
      steps {
        // start checkout
        echo 'start checkout'
        echo "Building ${BRANCH_NAME}"
        echo "Current workspace : ${workspace}"

        // copy workspace -> shared
        echo 'copy workspace diretory'
        sh 'cp -rf ./* /shared'
      }
    }
    stage('Develop Deploy') {
      agent any
      when {
        branch 'develop'
      }
      steps {
        retry(2) {
          timeout(2) { // 2 minutes
            // npm install
            echo 'npm install'
            sh 'npm --prefix /shared install /shared'

            // pm2 delete & star
            echo 'pm2 develop delete and start'
            sh 'pm2 start /app/bin/www --name develop'
          }
        }
      }
    }
  }
}
